<script setup>
import { ref, onBeforeMount, onMounted, watch } from "vue";
import EntryCard from "../components/EntryCard.vue";
import SortButton from "./small_components/SortButton.vue";
import LoadingIcon from "./small_components/LoadingIcon.vue";
import { userStatusStore } from "../stores/counter";

// Methods import
import searchUserEntries from "../methods/searchUserEntries.js";

// Variables
let selectedCategory = ref("");
let selectedTier = ref("");
let selectedSort = ref("");

const searchInput = ref("");
const searchStarted = ref(false);
const displaySearchError = ref(false);

// Instance pinia user store
const userStore = ref(userStatusStore());
const user_id = userStore.value.getUserInfo().id;

// Request in progress indicator
let displaySearchProgressIcon = ref(false);

// Internal search array
let searchResults = ref([]);

// Internal Methods
function instanceSUE() {
   searchStarted.value = true;
   if (selectedCategory.value === "" || selectedTier.value === "") {
      displaySearchError.value = true;
   } else {
      // console.log("hello world");
      // Display the loading icon
      displaySearchProgressIcon.value = true;

      // Instance the imported search function
      const SUE = searchUserEntries(
         selectedCategory.value,
         selectedTier.value,
         user_id,
         searchInput.value
      );

      // Once search is done, remove display loading icon
      SUE.then((value) => {
         displaySearchProgressIcon.value = false;
         searchResults.value = value;
         console.log(searchResults.value);
      });

      displaySearchError.value = false;
   }
}

defineProps({
   info: Array,
});
</script>

<template>
   <section class="mt-12 w-4/6">
      <div class="flex items-center gap-4 w-full mx-auto justify-between">
         <input
            v-model="searchInput"
            @keyup.enter="instanceSUE"
            placeholder="Search for an history entry"
            class="flex-1 h-10 rounded-[10px] border border-secondary px-2.5 py-2 bg-transparent focus:outline-none focus:outline-tertiary"
         />
         <!-- Search filter options -->
         <div class="flex gap-4">
            <select
               v-model="selectedCategory"
               class="flex justify-between pr-10 px-2.5 py-2 rounded-[10px] bg-tertiary border border-secondary shadow-brutal-sm font-semibold focus:outline-none focus:ring-0 focus:border-secondary"
            >
               <option class="" disabled value="" selected>Category</option>
               <option class="" value="Provinces">Provinces</option>
               <option class="" value="Titles">Titles</option>
            </select>

            <select
               v-model="selectedTier"
               class="flex justify-between pr-10 px-2.5 py-2 rounded-[10px] bg-tertiary border border-secondary shadow-brutal-sm font-semibold focus:outline-none focus:ring-0 focus:border-secondary"
            >
               <option class="" disabled value="" selected>Tier</option>
               <option class="" value="Empire">Empire</option>
               <option class="" value="Kingdom">Kingdom</option>
               <option class="" value="Duchy">Duchy</option>
            </select>

            <select
               v-model="selectedSort"
               class="flex justify-between pr-10 px-2.5 py-2 rounded-[10px] bg-tertiary border border-secondary shadow-brutal-sm font-semibold focus:outline-none focus:ring-0 focus:border-secondary"
            >
               <option class="" disabled value="" selected>Sort</option>
               <option class="" value="Name">Name</option>
               <option class="" value="Date">Date</option>
            </select>
         </div>
      </div>
      <article class="mt-16">
         <p v-if="displaySearchProgressIcon" class="flex gap-4">
            Loading... <LoadingIcon></LoadingIcon>
         </p>
         <p v-if="displaySearchError">
            Specify a Category or a Tier to make your search
         </p>
         <!-- Placeholder results -->
         <ul v-if="!searchStarted" class="mt-6 grid grid-cols-3 gap-10">
            <li v-for="entry in info" :key="entry.id">
               <EntryCard
                  v-if="entry.barony"
                  :title="entry.barony"
                  :date="entry.date"
               >
                  <svg
                     width="27"
                     height="30"
                     viewBox="0 0 27 30"
                     fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     class=""
                     preserveAspectRatio="xMidYMid meet"
                  >
                     <path
                        d="M3.60574 22.7178C3.91494 22.0352 3.71901 21.3647 3.37921 21.1137C2.66898 20.5872 2.35673 19.8371 3.11287 19.2494C3.94555 18.582 3.76799 17.9759 3.38839 17.4309C2.9047 16.8707 2.32611 16.3227 0.871986 17.4707C0.437279 17.8473 -0.230088 17.3728 0.0791048 16.8952C0.587284 16.0962 1.2822 15.4809 2.27713 15.1043C2.78225 14.8962 3.26288 14.1186 2.8649 13.7237C2.39346 13.4727 2.10876 12.9645 2.37815 11.9328C2.53122 11.0695 2.36285 10.6073 1.83018 10.2736C2.03223 9.73478 2.19754 9.18987 2.20366 8.59291C2.10876 7.60717 1.97406 6.75 1.80875 6.09181C2.121 5.20709 2.44244 4.35911 3.0945 3.4499C3.67921 2.60804 4.83027 1.79679 6.16194 2.36313C6.78339 2.60804 7.50892 2.86212 7.79056 2.65702C8.32629 2.3019 8.12119 1.96516 7.67423 1.57637C7.1385 1.16615 6.7191 0.670221 7.51505 0.315108C8.81917 -0.291033 10.1049 0.0242827 11.057 0.860022C11.8284 1.25187 12.603 1.50902 13.3744 1.57025C14.2867 1.56413 14.8194 2.04781 15.802 2.8162C16.8674 3.48357 18.0276 3.43765 19.2062 1.5029C19.4236 3.42847 20.293 3.29683 21.4777 1.73556C22.3869 1.45392 23.4492 2.75804 22.9869 4.09277C22.7176 4.53054 22.9931 4.96831 24.2176 5.40608C24.2268 5.38771 24.2329 5.36934 24.2421 5.35098C26.3299 7.06225 26.137 10.047 24.3156 11.244C23.3268 11.5746 23.1921 12.7073 23.6451 13.5951C24.1686 14.0482 24.6615 15.0554 24.539 15.7993C24.288 17.0789 25.5156 17.9054 26.2534 19.4116C25.0013 20.7341 25.7268 21.0708 26.3268 20.6912C26.7371 20.2994 26.8809 20.7708 26.5258 21.2882C25.7391 22.3903 25.7544 23.7158 25.9534 24.9924C25.0105 26.0302 24.0156 25.8679 23.0329 25.2251C22.3257 24.7261 21.1257 25.1546 20.2563 26.1802C22.1451 25.9781 22.0134 28.0292 20.7706 28.1731C19.993 26.8567 19.0868 26.3884 17.9327 26.6333C17.048 26.8169 16.7817 27.2118 17.0572 27.7262C17.2745 28.1853 16.8827 29.3456 16.5245 29.5782C16.1571 29.217 15.3704 28.8129 14.5744 29.615C13.803 30.3466 13.3744 30.0558 13.4295 28.568C13.4142 28.1915 13.3346 27.8149 12.9856 27.4384C12.8019 27.1261 12.1591 27.022 11.7886 28.2986C11.5101 28.7119 11.155 28.6262 11.0141 28.2466C10.7998 27.8455 10.9652 27.2088 11.6815 26.2322C12.3734 25.4332 12.453 24.7689 12.9305 23.774C13.0652 23.4403 13.2856 22.9811 12.4438 23.2076C11.507 23.3301 11.5162 22.9719 11.7397 21.4688C11.6937 20.8872 11.3233 20.6147 10.7723 20.7678C10.1998 20.8443 10.0529 21.4168 9.07938 21.1688C8.70284 21.1382 8.32017 21.2484 8.24364 21.6127C8.14568 22.2433 7.91608 22.8617 7.48443 23.2168C7.24871 23.2658 6.88748 22.6076 6.58747 22.3015C6.34256 21.7841 5.71193 21.8086 5.48233 22.4576C5.33233 22.9107 4.9864 23.2474 4.4874 23.027C4.26086 22.828 3.90881 22.7454 3.60574 22.7178Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M13.9469 10.0685C13.0377 10.0685 12.2999 10.8063 12.2999 11.7155C12.2999 12.6247 13.0377 13.3625 13.9469 13.3625C14.8561 13.3625 15.5939 12.6247 15.5939 11.7155C15.5939 10.8063 14.8561 10.0685 13.9469 10.0685Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M16.7021 10.549C16.5521 10.1939 16.3378 9.87554 16.0623 9.60002C15.7868 9.32451 15.4684 9.11021 15.1133 8.96021C14.7459 8.80408 14.3541 8.72449 13.95 8.72449C13.5459 8.72449 13.1571 8.80408 12.7867 8.96021C12.4316 9.11021 12.1132 9.32451 11.8377 9.60002C11.5622 9.87554 11.3479 10.1939 11.1979 10.549C11.0418 10.9164 10.9622 11.3082 10.9622 11.7123C10.9622 12.1164 11.0418 12.5052 11.1979 12.8756C11.3479 13.2307 11.5622 13.5491 11.8377 13.8246C12.1132 14.1002 12.4316 14.3145 12.7867 14.4645C13.1541 14.6206 13.5459 14.7002 13.95 14.7002C14.3541 14.7002 14.7429 14.6206 15.1133 14.4645C15.4684 14.3145 15.7868 14.1002 16.0623 13.8246C16.3378 13.5491 16.5521 13.2307 16.7021 12.8756C16.8583 12.5083 16.9379 12.1164 16.9379 11.7123C16.9379 11.3082 16.8583 10.9164 16.7021 10.549ZM16.4511 11.7123C16.4511 13.0899 15.3307 14.2104 13.9531 14.2104C12.5755 14.2104 11.455 13.0899 11.455 11.7123C11.455 10.3347 12.5755 9.2143 13.9531 9.2143C15.3307 9.21124 16.4511 10.3317 16.4511 11.7123Z"
                        fill="#3A343A"
                     ></path>
                  </svg>
               </EntryCard>
               <EntryCard
                  v-if="entry.title"
                  :title="entry.title"
                  :date="entry.date"
               >
                  <svg
                     width="24"
                     height="30"
                     viewBox="0 0 24 30"
                     fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     class=""
                     preserveAspectRatio="xMidYMid meet"
                  >
                     <path
                        d="M23.5548 0H0V23.0666H6.93334V30H23.5548V0ZM3.45305 3.51586H12.6202V5.29811H3.45305V3.51586ZM3.45305 6.48645H12.6201V8.26869H3.45305V6.48645ZM3.45305 9.45709H12.6201V11.2393H3.45305V9.45709ZM20.1018 20.69H3.45305V18.9078H20.1018V20.69H20.1018ZM20.1018 17.7195H3.45305V15.9372H20.1018V17.7195H20.1018ZM20.0457 8.7682V12.5834L17.7607 11.7626L15.4756 12.5834V8.7682C14.6291 8.0942 14.0849 7.05592 14.0849 5.89225C14.0849 3.86549 15.7339 2.21654 17.7606 2.21654C19.7874 2.21654 21.4363 3.86549 21.4363 5.89225C21.4365 7.05598 20.8922 8.09426 20.0457 8.7682Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M0.521973 24.8489L5.15105 29.478V24.8489H0.521973Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M17.7606 3.99878C16.7166 3.99878 15.8672 4.84821 15.8672 5.89224C15.8672 6.93626 16.7166 7.78569 17.7606 7.78569C18.8047 7.78569 19.6541 6.93626 19.6541 5.89224C19.6541 4.84821 18.8047 3.99878 17.7606 3.99878Z"
                        fill="#3A343A"
                     ></path>
                  </svg>
               </EntryCard>
            </li>
         </ul>
         <!-- Province Search results -->
         <ul
            v-if="searchStarted && selectedCategory === 'Provinces'"
            class="mt-6 grid grid-cols-3 gap-10"
         >
            <li v-for="entry in searchResults" :key="entry.id">
               <EntryCard
                  v-if="entry.barony"
                  :title="entry.barony"
                  :date="entry.date"
               >
                  <svg
                     width="27"
                     height="30"
                     viewBox="0 0 27 30"
                     fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     class=""
                     preserveAspectRatio="xMidYMid meet"
                  >
                     <path
                        d="M3.60574 22.7178C3.91494 22.0352 3.71901 21.3647 3.37921 21.1137C2.66898 20.5872 2.35673 19.8371 3.11287 19.2494C3.94555 18.582 3.76799 17.9759 3.38839 17.4309C2.9047 16.8707 2.32611 16.3227 0.871986 17.4707C0.437279 17.8473 -0.230088 17.3728 0.0791048 16.8952C0.587284 16.0962 1.2822 15.4809 2.27713 15.1043C2.78225 14.8962 3.26288 14.1186 2.8649 13.7237C2.39346 13.4727 2.10876 12.9645 2.37815 11.9328C2.53122 11.0695 2.36285 10.6073 1.83018 10.2736C2.03223 9.73478 2.19754 9.18987 2.20366 8.59291C2.10876 7.60717 1.97406 6.75 1.80875 6.09181C2.121 5.20709 2.44244 4.35911 3.0945 3.4499C3.67921 2.60804 4.83027 1.79679 6.16194 2.36313C6.78339 2.60804 7.50892 2.86212 7.79056 2.65702C8.32629 2.3019 8.12119 1.96516 7.67423 1.57637C7.1385 1.16615 6.7191 0.670221 7.51505 0.315108C8.81917 -0.291033 10.1049 0.0242827 11.057 0.860022C11.8284 1.25187 12.603 1.50902 13.3744 1.57025C14.2867 1.56413 14.8194 2.04781 15.802 2.8162C16.8674 3.48357 18.0276 3.43765 19.2062 1.5029C19.4236 3.42847 20.293 3.29683 21.4777 1.73556C22.3869 1.45392 23.4492 2.75804 22.9869 4.09277C22.7176 4.53054 22.9931 4.96831 24.2176 5.40608C24.2268 5.38771 24.2329 5.36934 24.2421 5.35098C26.3299 7.06225 26.137 10.047 24.3156 11.244C23.3268 11.5746 23.1921 12.7073 23.6451 13.5951C24.1686 14.0482 24.6615 15.0554 24.539 15.7993C24.288 17.0789 25.5156 17.9054 26.2534 19.4116C25.0013 20.7341 25.7268 21.0708 26.3268 20.6912C26.7371 20.2994 26.8809 20.7708 26.5258 21.2882C25.7391 22.3903 25.7544 23.7158 25.9534 24.9924C25.0105 26.0302 24.0156 25.8679 23.0329 25.2251C22.3257 24.7261 21.1257 25.1546 20.2563 26.1802C22.1451 25.9781 22.0134 28.0292 20.7706 28.1731C19.993 26.8567 19.0868 26.3884 17.9327 26.6333C17.048 26.8169 16.7817 27.2118 17.0572 27.7262C17.2745 28.1853 16.8827 29.3456 16.5245 29.5782C16.1571 29.217 15.3704 28.8129 14.5744 29.615C13.803 30.3466 13.3744 30.0558 13.4295 28.568C13.4142 28.1915 13.3346 27.8149 12.9856 27.4384C12.8019 27.1261 12.1591 27.022 11.7886 28.2986C11.5101 28.7119 11.155 28.6262 11.0141 28.2466C10.7998 27.8455 10.9652 27.2088 11.6815 26.2322C12.3734 25.4332 12.453 24.7689 12.9305 23.774C13.0652 23.4403 13.2856 22.9811 12.4438 23.2076C11.507 23.3301 11.5162 22.9719 11.7397 21.4688C11.6937 20.8872 11.3233 20.6147 10.7723 20.7678C10.1998 20.8443 10.0529 21.4168 9.07938 21.1688C8.70284 21.1382 8.32017 21.2484 8.24364 21.6127C8.14568 22.2433 7.91608 22.8617 7.48443 23.2168C7.24871 23.2658 6.88748 22.6076 6.58747 22.3015C6.34256 21.7841 5.71193 21.8086 5.48233 22.4576C5.33233 22.9107 4.9864 23.2474 4.4874 23.027C4.26086 22.828 3.90881 22.7454 3.60574 22.7178Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M13.9469 10.0685C13.0377 10.0685 12.2999 10.8063 12.2999 11.7155C12.2999 12.6247 13.0377 13.3625 13.9469 13.3625C14.8561 13.3625 15.5939 12.6247 15.5939 11.7155C15.5939 10.8063 14.8561 10.0685 13.9469 10.0685Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M16.7021 10.549C16.5521 10.1939 16.3378 9.87554 16.0623 9.60002C15.7868 9.32451 15.4684 9.11021 15.1133 8.96021C14.7459 8.80408 14.3541 8.72449 13.95 8.72449C13.5459 8.72449 13.1571 8.80408 12.7867 8.96021C12.4316 9.11021 12.1132 9.32451 11.8377 9.60002C11.5622 9.87554 11.3479 10.1939 11.1979 10.549C11.0418 10.9164 10.9622 11.3082 10.9622 11.7123C10.9622 12.1164 11.0418 12.5052 11.1979 12.8756C11.3479 13.2307 11.5622 13.5491 11.8377 13.8246C12.1132 14.1002 12.4316 14.3145 12.7867 14.4645C13.1541 14.6206 13.5459 14.7002 13.95 14.7002C14.3541 14.7002 14.7429 14.6206 15.1133 14.4645C15.4684 14.3145 15.7868 14.1002 16.0623 13.8246C16.3378 13.5491 16.5521 13.2307 16.7021 12.8756C16.8583 12.5083 16.9379 12.1164 16.9379 11.7123C16.9379 11.3082 16.8583 10.9164 16.7021 10.549ZM16.4511 11.7123C16.4511 13.0899 15.3307 14.2104 13.9531 14.2104C12.5755 14.2104 11.455 13.0899 11.455 11.7123C11.455 10.3347 12.5755 9.2143 13.9531 9.2143C15.3307 9.21124 16.4511 10.3317 16.4511 11.7123Z"
                        fill="#3A343A"
                     ></path>
                  </svg>
               </EntryCard>
            </li>
         </ul>
         <!-- Title search results -->
         <ul
            v-if="searchStarted && selectedCategory === 'Titles'"
            class="mt-6 grid grid-cols-3 gap-10"
         >
            <li v-for="entry in searchResults" :key="entry.id">
               <EntryCard
                  v-if="entry.title"
                  :title="entry.title"
                  :date="entry.date"
               >
                  <svg
                     width="24"
                     height="30"
                     viewBox="0 0 24 30"
                     fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     class=""
                     preserveAspectRatio="xMidYMid meet"
                  >
                     <path
                        d="M23.5548 0H0V23.0666H6.93334V30H23.5548V0ZM3.45305 3.51586H12.6202V5.29811H3.45305V3.51586ZM3.45305 6.48645H12.6201V8.26869H3.45305V6.48645ZM3.45305 9.45709H12.6201V11.2393H3.45305V9.45709ZM20.1018 20.69H3.45305V18.9078H20.1018V20.69H20.1018ZM20.1018 17.7195H3.45305V15.9372H20.1018V17.7195H20.1018ZM20.0457 8.7682V12.5834L17.7607 11.7626L15.4756 12.5834V8.7682C14.6291 8.0942 14.0849 7.05592 14.0849 5.89225C14.0849 3.86549 15.7339 2.21654 17.7606 2.21654C19.7874 2.21654 21.4363 3.86549 21.4363 5.89225C21.4365 7.05598 20.8922 8.09426 20.0457 8.7682Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M0.521973 24.8489L5.15105 29.478V24.8489H0.521973Z"
                        fill="#3A343A"
                     ></path>
                     <path
                        d="M17.7606 3.99878C16.7166 3.99878 15.8672 4.84821 15.8672 5.89224C15.8672 6.93626 16.7166 7.78569 17.7606 7.78569C18.8047 7.78569 19.6541 6.93626 19.6541 5.89224C19.6541 4.84821 18.8047 3.99878 17.7606 3.99878Z"
                        fill="#3A343A"
                     ></path>
                  </svg>
               </EntryCard>
            </li>
         </ul>
      </article>
   </section>
</template>
